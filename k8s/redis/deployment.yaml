apiVersion: apps/v1
kind: Deployment
metadata:
    name: backtrade-redis
    namespace: backtrade
    labels:
        app: redis
        component: cache
spec:
    replicas: 1
    selector:
        matchLabels:
            app: redis
            component: cache
    template:
        metadata:
            labels:
                app: redis
                component: cache
        spec:
            containers:
                - name: redis
                  image: redis:7-alpine
                  ports:
                      - containerPort: 6379
                        name: redis
                        protocol: TCP
                  securityContext:
                      allowPrivilegeEscalation: false
                      runAsNonRoot: true
                      runAsUser: 999
                      capabilities:
                          drop:
                              - ALL
                  command:
                      - /bin/sh
                      - -c
                      - redis-server --requirepass "${REDIS_PASSWORD}" --appendonly no --save ""
                  env:
                      - name: REDIS_PASSWORD
                        valueFrom:
                            secretKeyRef:
                                name: backtrade-secrets
                                key: REDIS_PASSWORD
                  resources:
                      requests:
                          memory: "128Mi"
                          cpu: "100m"
                      limits:
                          memory: "512Mi"
                          cpu: "500m"
                  livenessProbe:
                      exec:
                          command:
                              - /bin/sh
                              - -c
                              - redis-cli -a "$REDIS_PASSWORD" ping
                      initialDelaySeconds: 30
                      periodSeconds: 10
                      timeoutSeconds: 5
                      failureThreshold: 3
                  readinessProbe:
                      exec:
                          command:
                              - /bin/sh
                              - -c
                              - redis-cli -a "$REDIS_PASSWORD" ping
                      initialDelaySeconds: 10
                      periodSeconds: 5
                      timeoutSeconds: 3
                      failureThreshold: 3

