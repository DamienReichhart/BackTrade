sequenceDiagram
    participant User
    participant Browser
    participant ForgotPassword
    participant ForgotPasswordFormPanel
    participant useForgotPasswordForm
    participant ValidationUtils
    participant useForgotPassword
    participant useResetPassword
    participant useFetch
    participant executeFetch
    participant API
    participant Router
    
    User->>Browser: Navigate to /forgot-password
    Browser->>Router: Route to ForgotPassword component
    Router->>ForgotPassword: Render ForgotPassword page
    ForgotPassword->>ForgotPasswordFormPanel: Render form panel (Step 1)
    ForgotPassword->>ForgotPasswordInfoPanel: Render info panel
    
    Note over ForgotPasswordFormPanel,useForgotPasswordForm: Step 1: Request Password Reset Code
    
    User->>ForgotPasswordFormPanel: Enter email
    ForgotPasswordFormPanel->>useForgotPasswordForm: handleEmailChange(email)
    useForgotPasswordForm->>ValidationUtils: validateEmail(email)
    ValidationUtils-->>useForgotPasswordForm: validation result
    useForgotPasswordForm-->>ForgotPasswordFormPanel: Update form state & errors
    
    User->>ForgotPasswordFormPanel: Click "Send Code" button
    ForgotPasswordFormPanel->>useForgotPasswordForm: handleStep1Submit(event)
    
    useForgotPasswordForm->>ValidationUtils: validateEmail(formState.email)
    
    alt Validation fails
        ValidationUtils-->>useForgotPasswordForm: Validation error
        useForgotPasswordForm-->>ForgotPasswordFormPanel: Set email error
        ForgotPasswordFormPanel->>User: Display validation error
    else Validation succeeds
        useForgotPasswordForm->>useForgotPassword: execute({ email })
        useForgotPassword->>useFetch: Execute POST /auth/users/requester/password
        useFetch->>executeFetch: executeFetch(body, config)
        executeFetch->>API: POST /auth/users/requester/password<br/>{ email }
        
        alt Request successful
            API-->>executeFetch: 200 OK
            executeFetch-->>useFetch: EmptyResponse
            useFetch-->>useForgotPassword: EmptyResponse
            useForgotPassword-->>useForgotPasswordForm: Success
            
            useForgotPasswordForm->>useForgotPasswordForm: setStep(2)
            useForgotPasswordForm-->>ForgotPasswordFormPanel: Update to Step 2
            ForgotPasswordFormPanel->>User: Display code & password inputs
        else User not found
            API-->>executeFetch: 404 Not Found<br/>{ error: "User not found" }
            executeFetch-->>useFetch: Error
            useFetch-->>useForgotPassword: Error
            useForgotPassword-->>useForgotPasswordForm: Error
            useForgotPasswordForm-->>ForgotPasswordFormPanel: Set email error
            ForgotPasswordFormPanel->>User: Display "User not found" error
        else Request failed
            API-->>executeFetch: 500 Internal Server Error
            executeFetch-->>useFetch: Error
            useFetch-->>useForgotPassword: Error
            useForgotPassword-->>useForgotPasswordForm: Error
            useForgotPasswordForm-->>ForgotPasswordFormPanel: Set general error
            ForgotPasswordFormPanel->>User: Display error message
        end
    end
    
    Note over ForgotPasswordFormPanel,useForgotPasswordForm: Step 2: Reset Password with Code
    
    alt Step 2 active
        User->>ForgotPasswordFormPanel: Enter verification code
        ForgotPasswordFormPanel->>useForgotPasswordForm: handleCodeChange(code)
        useForgotPasswordForm-->>ForgotPasswordFormPanel: Update form state & errors
        
        User->>ForgotPasswordFormPanel: Enter new password
        ForgotPasswordFormPanel->>useForgotPasswordForm: handleNewPasswordChange(password)
        useForgotPasswordForm->>ValidationUtils: validatePassword(password)
        ValidationUtils-->>useForgotPasswordForm: validation result
        useForgotPasswordForm-->>ForgotPasswordFormPanel: Update form state & errors
        
        User->>ForgotPasswordFormPanel: Click "Reset Password" button
        ForgotPasswordFormPanel->>useForgotPasswordForm: handleStep2Submit(event)
        
        useForgotPasswordForm->>ValidationUtils: validatePassword(formState.newPassword)
        
        alt Validation fails
            ValidationUtils-->>useForgotPasswordForm: Validation error
            useForgotPasswordForm-->>ForgotPasswordFormPanel: Set password error
            ForgotPasswordFormPanel->>User: Display validation error
        else Code empty
            useForgotPasswordForm-->>ForgotPasswordFormPanel: Set code error
            ForgotPasswordFormPanel->>User: Display "Enter verification code" error
        else Validation succeeds
            useForgotPasswordForm->>useResetPassword: execute({ code, newPassword })
            useResetPassword->>useFetch: Execute POST /auth/users/resetter/password
            useFetch->>executeFetch: executeFetch(body, config)
            executeFetch->>API: POST /auth/users/resetter/password<br/>{ code, newPassword }
            
            alt Reset successful
                API-->>executeFetch: 200 OK or 204 No Content
                executeFetch-->>useFetch: EmptyResponse
                useFetch-->>useResetPassword: EmptyResponse
                useResetPassword-->>useForgotPasswordForm: Success
                
                useForgotPasswordForm->>Router: navigate("/signin")
                Router->>Browser: Navigate to login page
                Browser->>User: Display login page
            else Invalid code
                API-->>executeFetch: 403 Forbidden<br/>{ error: "Invalid verification code" }
                executeFetch-->>useFetch: Error
                useFetch-->>useResetPassword: Error
                useResetPassword-->>useForgotPasswordForm: Error
                useForgotPasswordForm-->>ForgotPasswordFormPanel: Set code error
                ForgotPasswordFormPanel->>User: Display "Invalid verification code" error
            else Reset failed
                API-->>executeFetch: 500 Internal Server Error
                executeFetch-->>useFetch: Error
                useFetch-->>useResetPassword: Error
                useResetPassword-->>useForgotPasswordForm: Error
                useForgotPasswordForm-->>ForgotPasswordFormPanel: Set general error
                ForgotPasswordFormPanel->>User: Display error message
            end
        end
        
        User->>ForgotPasswordFormPanel: Click "Back" button
        ForgotPasswordFormPanel->>useForgotPasswordForm: handleBackToStep1()
        useForgotPasswordForm->>useForgotPasswordForm: setStep(1)
        useForgotPasswordForm-->>ForgotPasswordFormPanel: Reset to Step 1
    end

