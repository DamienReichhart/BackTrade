flowchart TD
    Start([Admin clicks Upload button]) --> SelectFile[File picker opens]
    
    SelectFile --> UserSelects{User selects file?}
    UserSelects -->|Cancel| End([Cancel upload])
    UserSelects -->|Select| ValidateFileType{File type is CSV?}
    
    ValidateFileType -->|No| ShowTypeError[Display error:<br/>File must be CSV]
    ShowTypeError --> SelectFile
    
    ValidateFileType -->|Yes| ValidateSize{File size within limits?}
    ValidateSize -->|No| ShowSizeError[Display error:<br/>File too large]
    ShowSizeError --> SelectFile
    
    ValidateSize -->|Yes| ReadFile[Read file contents]
    ReadFile --> ParseCSV[Parse CSV structure]
    
    ParseCSV --> ValidateStructure{Valid CSV structure?<br/>- Headers present<br/>- Columns match expected}
    ValidateStructure -->|No| ShowStructureError[Display error:<br/>Invalid CSV format]
    ShowStructureError --> SelectFile
    
    ValidateStructure -->|Yes| CreateFormData[Create FormData object]
    CreateFormData --> ShowProgress[Show upload progress indicator]
    ShowProgress --> SubmitAPI[POST /datasets/:id/upload]
    
    SubmitAPI --> BackendReceive[Backend receives file]
    BackendReceive --> BackendValidate[Backend validates file]
    
    BackendValidate --> BackendValid{Backend validation passes?}
    BackendValid -->|No| BackendError[Backend returns error]
    BackendError --> ShowAPIError[Display API error message]
    ShowAPIError --> SelectFile
    
    BackendValid -->|Yes| ProcessCSV[Backend processes CSV:<br/>- Parse each row<br/>- Extract OHLCV data<br/>- Validate timestamps<br/>- Validate price data]
    
    ProcessCSV --> ValidateData{Data validation passes?<br/>- Timestamps sequential<br/>- Prices valid<br/>- No gaps in data}
    ValidateData -->|No| DataError[Backend returns data error]
    DataError --> ShowAPIError
    
    ValidateData -->|Yes| CalculateStats[Calculate dataset statistics:<br/>- Count records<br/>- Find start_time<br/>- Find end_time<br/>- Validate date range]
    
    CalculateStats --> StoreRecords[Store records in database]
    StoreRecords --> UpdateDataset[Update dataset record:<br/>- file_name<br/>- records_count<br/>- start_time<br/>- end_time<br/>- uploaded_at]
    
    UpdateDataset --> Success[Return success response]
    Success --> ShowSuccess[Display success message]
    ShowSuccess --> RefreshList[Refresh datasets list]
    RefreshList --> EndSuccess([Upload complete])
    
    style Start fill:#e1f5ff
    style ProcessCSV fill:#fff3e0
    style StoreRecords fill:#c8e6c9
    style EndSuccess fill:#c8e6c9
    style ShowAPIError fill:#ffcdd2

