name: CI

on:
    push:
        branches: [main, dev, feature/*]
    pull_request:
        branches: [main, dev]

jobs:
    setup:
        name: Setup
        runs-on: ubuntu-latest
        outputs:
            node: ${{ steps.versions.outputs.node }}
            pnpm: ${{ steps.versions.outputs.pnpm }}
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup toolchain
              uses: ./.github/actions/setup

            - id: versions
              name: Record versions
              run: |
                  echo "node=$(node -v)" >> $GITHUB_OUTPUT
                  echo "pnpm=$(pnpm -v)" >> $GITHUB_OUTPUT
              shell: bash

    lint:
        name: Lint
        runs-on: ubuntu-latest
        needs: [setup]
        steps:
            - uses: actions/checkout@v4
            - uses: ./.github/actions/setup
            - uses: ./.github/actions/prisma-generate
              with:
                  database-url: ${{ secrets.DATABASE_URL }}
            - uses: ./.github/actions/lint

    typecheck:
        name: Typecheck
        runs-on: ubuntu-latest
        needs: [setup]
        steps:
            - uses: actions/checkout@v4
            - uses: ./.github/actions/setup
            - uses: ./.github/actions/prisma-generate
              with:
                  database-url: ${{ secrets.DATABASE_URL }}
            - uses: ./.github/actions/typecheck

    test:
        name: Test
        runs-on: ubuntu-latest
        needs: [setup]
        steps:
            - uses: actions/checkout@v4
            - uses: ./.github/actions/setup
            - uses: ./.github/actions/prisma-generate
              with:
                  database-url: ${{ secrets.DATABASE_URL }}
            - uses: ./.github/actions/test

    coverage:
        name: Coverage
        runs-on: ubuntu-latest
        needs: [setup]
        steps:
            - name: Checkout
              uses: actions/checkout@v4
            - name: Setup
              uses: ./.github/actions/setup
            - name: Generate Prisma Client
              uses: ./.github/actions/prisma-generate
              with:
                  database-url: ${{ secrets.DATABASE_URL }}
            - name: Run Coverage
              uses: ./.github/actions/test-coverage
            - name: Upload API coverage artifact
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: api-coverage
                  path: apps/api/coverage
                  if-no-files-found: warn
            - name: Upload Web coverage artifact
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: web-coverage
                  path: apps/web/coverage
                  if-no-files-found: warn

    semgrep:
        name: Semgrep Security Scan
        runs-on: ubuntu-latest
        needs: setup
        permissions:
            security-events: write
            actions: read
            contents: read
        steps:
            - uses: actions/checkout@v4
            - uses: ./.github/actions/semgrep
              with:
                  semgrep-app-token: ${{ secrets.SEMGREP_APP_TOKEN }}

    build:
        name: Build
        runs-on: ubuntu-latest
        needs: [lint, typecheck, test, coverage, semgrep]
        steps:
            - uses: actions/checkout@v4
            - uses: ./.github/actions/setup
            - uses: ./.github/actions/prisma-generate
              with:
                  database-url: ${{ secrets.DATABASE_URL }}
            - uses: ./.github/actions/build
